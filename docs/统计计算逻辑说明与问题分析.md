# 统计计算逻辑说明与问题分析

## 一、当前计算流程

```
用户输入 (school, major, region, education_level, started_time)
    │
    ├─► 机构统计
    │      load_institutions() → filter_institutions(region)
    │      统计数: len(inst_region)
    │
    ├─► 学校统计
    │      load_schools(region_filter) → filter_schools(省份, 专业, 年份)
    │      → unique_schools((机构名称, 开设专业, 年份))
    │      统计数: len(schools_region)
    │
    └─► 问卷星
           load_questionnaire() → filter_questionnaire_by_region()
           统计数: posting_sample_count = len(问卷行)
```

---

## 二、各统计项计算逻辑

### 2.1 机构数 (institution_count)

- **数据源**：`托育机构平台注册备案数据.json`
- **筛选**：`zoning_name` 解析出省/市，若 `region in (省, 市, zoning_name)` 或 `zoning_name.startswith(region)` 则保留
- **统计**：筛选后列表长度

### 2.2 学校数 (school_count)

- **数据源**：`moe_majors_{省}_{年}.txt`，按 `^_^` 切分记录
- **筛选**：
  - 省份 = region
  - 开设专业 匹配 major 或托育专业代码 (520802, 570101K, 660225)
  - 年份 >= started_time（若指定）
- **去重**：按 `(机构名称, 年份)` 去重——同一院校同一年不论学制(2/3/5 年)只计 1
- **统计**：去重后列表长度

> 原按 `(机构名称, 开设专业, 年份)` 去重得 219，会重复统计同年多学制；改为 `(机构名称, 年份)` 后约 182（广东省+婴幼儿托育服务与管理）。若期望 189，可能与数据版本或统计口径有关。

### 2.3 问卷星 (posting_sample_count)

- **数据源**：`问卷星统计_托育机构人才需求专项调查_20260120.xlsx`
- **统计**：有效行数（若按区域筛选有匹配则用区域子集，否则用全部）
- **岗位分布**：按「最缺岗位/岗位」等列聚合

---

## 三、已发现的问题

### 问题 1：学校详情混入非托育专业

**现象**：details.schools 中出现「水文与水资源 (570101)」

**原因**：历史缓存写入时 `TUOYU_MAJOR_CODES` 曾包含 `570101`，而 570101 对应水文与水资源，非托育专业。

**处理**：`TUOYU_MAJOR_CODES` 已改为仅 `("520802", "570101K")`。需**清空缓存**后重新统计：

```
删除 db/_stats_cache/cache.json 或调用 cache.clear_cache()
```

### 问题 2：早期教育专业代码不一致

**现象**：数据中有「早期教育 (660225)」，而配置只匹配 570101K

**原因**：不同年份/目录下早期教育代码可能为 660225 或 570101K。

**建议**：将 660225 加入托育专业代码，或扩展 `TUOYU_MAJOR_CODES` / `TUOYU_MAJOR_NAMES` 以覆盖多种代码。

### 问题 3：学校数统计口径

**当前**：按 `(机构名称, 开设专业, 年份)` 去重 → 统计「培养点」数量

**可能预期**：

- A) 培养点数量（当前实现）
- B) 院校数量：按 `机构名称` 去重

若需要「开设某专业的院校数」，应增加按机构名称去重的统计。

### 问题 4：问卷星为 0

**现象**：`posting_sample_count: 0`, `questionnaire_posting: {}`

**可能原因**：

1. pandas/openpyxl 未正确安装，xlsx 加载失败
2. 问卷星表头列名与代码中 `["最缺岗位","岗位",...]` 不一致
3. 按区域筛选时，问卷中无对应区域列或列名不匹配，导致筛选后为空

**建议**：用 `load_questionnaire_columns()` 查看实际列名，再调整 `_questionnaire_posting_stats` 和 `filter_questionnaire_by_region` 的列映射。

### 问题 5：学校 block 解析与第一块

**记录格式**：每条记录以 `^_^` 分隔，形如：

```
机构名称：安徽大学
省份：安徽省
...
备注：^_^机构名称：下一所学校
```

按 `^_^` 切分后，第一块可能以 `备注：` 结尾且无值。当前解析会跳过 `备注` 字段，逻辑正常，但需确认首块、末块是否解析完整。

---

## 四、修复建议汇总

| 序号 | 问题                   | 建议操作                                     |
| ---- | ---------------------- | -------------------------------------------- |
| 1    | 历史缓存导致错误专业   | 清空 `db/_stats_cache/cache.json`            |
| 2    | 早期教育 660225 未匹配 | 在 config 中增加 660225                      |
| 3    | 学校数口径不明确       | 视需求增加「院校数」统计（按机构名称去重）   |
| 4    | 问卷星为 0             | 检查 xlsx 列名并更新岗位/区域列映射          |
| 5    | 修业年限与学历层次     | 确认 2/3→ 专科、4/5→ 本科 的映射是否符合实际 |

---

## 五、验证步骤

1. 清空缓存后，用同一参数重新统计，确认学校详情中仅含托育相关专业。
2. 用 `load_questionnaire_columns()` 核对问卷星列名，并打印若干行原始数据。
3. 手工抽查：在机构 JSON、学校 txt 中数几条符合条件记录，与统计结果对比。
